---
title: "Data Analysis - Timing, Development and Diffusion of Work-Injury Laws Globally: Industrialization, Nation States and Institutions"
output: html_document
---

Nate Breznau
Felix Lanver
University of Bremen


```{r setup}
rm(list = ls(all = T))

pacman::p_load('netdiffuseR','stargazer','tidyverse','dplyr','countrycode','sandwich','lmtest','jtools','ragg','ggpubr')

load("data/.Rdata")

knitr::opts_chunk$set(echo = T)
```

## 1. Final Data Touch Ups


```{r final_cleaning, warning = F, message = F}
# Recode non-adopters to 2500
diff_data$toa[is.na(diff_data$toa)] <- 2500
diff_data_socins$toa[is.na(diff_data_socins$toa)] <- 2500

# change 'state existed' to, state founded in last 4 years

# FIRST LAW
diff_data <- diff_data %>%
  group_by(id) %>%
  mutate(existence = ifelse(existence - lag(existence) == 1, t, 0),
         existence = max(existence, na.rm = T),
         existence = ifelse(existence == 0, 1880, existence),
         existence = ifelse((t - existence) > -1 & (t - existence) < 5, 1, 0))

# SOCINS
diff_data_socins <- diff_data_socins %>%
  group_by(id) %>%
  mutate(year_nation = ifelse(existence - lag(existence) == 1, per, 0),
         existence = ifelse(existence - lag(existence) == 1, t, 0),
         year_nation = max(year_nation, na.rm = T),
         year_nation = ifelse(year_nation == 0, 1880, year_nation),
         existence = max(existence, na.rm = T),
         existence = ifelse(existence == 0, 1880, existence),
         formation = per - year_nation, # for treatment effect plot
         existence = ifelse((t - existence) > -1 & (t - existence) < 5, 1, 0))

treat_plot <- select(diff_data_socins, toa, id, per, formation, year_nation)
colnames(treat_plot) <- c("socins" ,"id","per","formation","year_nation")
treat_plot <- left_join(treat_plot, diff_data, by = c("id","per"))

# create sequence variable (1= no law, 2 = liability/fund, 3 = social insurance)
treat_plot <- treat_plot %>%
  mutate(law_seq = ifelse(per < toa, 1, 2),
         law_seq = ifelse(law_seq == 2 & per >= socins, 3, law_seq))
```

## 2. Main Models

### First Law

```{r main_models, warning = F, message = F}
# -----------------------------------------------------------------
# -----------------------------------------------------------------
# - 8. !! estimate discrete-time logistic hazard model !!
# -----------------------------------------------------------------





model1 <- glm(adopted ~ 
              + t0_22 
              + t23_48 
              + t49_74 
              + t75_99 
              + t100_130  
              + existence
              + lag_w_expo_culture 
              + w_expo_colony
              + lag_w_expo_trade
              + gdp10000
              + regime
              + 0,
      dat    = diff_data, 
      subset = (per <= toa), # - extremely important !
      family = binomial(link="logit"))
summary(model1)
exp(coef(model1))

model2 <- glm(adopted ~ 
                + t0_22 
              + t23_48 
              + t49_74 
              + t75_99 
              + t100_130  
              + existence
              + lag_w_expo_culture 
              + w_expo_colony
              + lag_w_expo_trade
              + lag_w_expo_proximity
              + gdp10000
              + regime
              + 0,
              dat    = diff_data, 
              subset = (per <= toa),
              family = binomial(link="logit"))
#summary(model2)
#exp(coef(model2))
stargazer(model1,model2,
          type = "html", 
          title = "Discrete Time Hazard/Diffusion Models of /nWork-Injury Law, 1880-2010 in 173 countries",
          dep.var.labels=c("First Work-Injury Law"),
          covariate.labels=c("(1880-1902)", 
                             "(1903-1928)",
                             "(1929-1954)",
                             "(1955-1979)",
                             "(1980-2010)",
                             "State Founded (last 4 years)", 
                             "Network Exposure: Culture (t-1)",
                             "Network Exposure: Colonial",
                             "Network Exposure: Trade (t-1)",
                             "Network Exposrue: Spatial Proximity",
                             "GDPpc 10k USD",
                             "Democratization" 
                             ),
          out="results/Tbl1.htm")

knitr::include_graphics("results/Tbl1.htm")
```

### Social Ins

```{r main_models_socins, warning = F, message = F}

model1_socins <- glm(adopted ~ 
              + t0_22 
              + t23_48 
              + t49_74 
              + t75_99 
              + t100_130  
              + existence
              + lag_w_expo_culture 
              + w_expo_colony
              + lag_w_expo_trade
              + gdp10000
              + regime
              + 0,
      dat    = diff_data_socins, 
      subset = (per <= toa), # - extremely important !
      family = binomial(link="logit"))
summary(model1_socins)
exp(coef(model1_socins))

model2_socins <- glm(adopted ~ 
                + t0_22 
              + t23_48 
              + t49_74 
              + t75_99 
              + t100_130  
              + existence
              + lag_w_expo_culture 
              + w_expo_colony
              + lag_w_expo_trade
              + lag_w_expo_proximity
              + gdp10000
              + regime
              + 0,
              dat    = diff_data_socins, 
              subset = (per <= toa),
              family = binomial(link="logit"))
#summary(model2)
#exp(coef(model2))
stargazer(model1_socins,model2_socins,
          type = "html", 
          title = "Discrete Time Hazard/Diffusion Models of /nWork-Injury Law, 1880-2010 in 173 countries",
          dep.var.labels=c("First Work-Injury Social Insurance Law"),
          covariate.labels=c("(1880-1902)", 
                             "(1903-1928)",
                             "(1929-1954)",
                             "(1955-1979)",
                             "(1980-2010)",
                             "State Founded (last 4 years)", 
                             "Network Exposure: Culture (t-1)",
                             "Network Exposure: Colonial",
                             "Network Exposure: Trade (t-1)",
                             "Network Exposrue: Spatial Proximity",
                             "GDPpc 10k USD",
                             "Democratization" 
                             ),
          out="results/Tbl2.htm")

knitr::include_graphics("results/Tbl2.htm")
```

### Odd-Ratios

#### First law

```{r Tbl1_OR, warning = F, message = F}
#we add a command to present odd-ratios

stargazer(model1,model2,
          type = "html", 
          title = "Discrete Time Hazard/Diffusion Models of /nWork-Injury Law, 1880-2010 in 173 countries",
          dep.var.labels=c("First Work-Injury Law"),
          covariate.labels=c("(1880-1902)", 
                             "(1903-1928)",
                             "(1929-1954)",
                             "(1955-1979)",
                             "(1980-2010)",
                             "State Founded (last 3 years)", 
                             "Network Exposure: Culture (t-1)",
                             "Network Exposure: Colonial",
                             "Network Exposure: Trade (t-1)",
                             "Network Exposrue: Spatial Proximity",
                             "GDPpc 10k USD",
                             "Democratization" 
                             ),
          apply.coef=exp, t.auto=F, p.auto=F, report = "vct*",
          out="results/Tbl1_OR.htm")

knitr::include_graphics("results/Tbl1_OR.htm")
```

#### Social insurance

```{r Tbl2_OR_socins, warning = F, message = F}
#we add a command to present odd-ratios

stargazer(model1_socins,model2_socins,
          type = "html", 
          title = "Discrete Time Hazard/Diffusion Models of /nWork-Injury Law, 1880-2010 in 173 countries",
          dep.var.labels=c("First Work-Injury Social Insurance Law"),
          covariate.labels=c("(1880-1902)", 
                             "(1903-1928)",
                             "(1929-1954)",
                             "(1955-1979)",
                             "(1980-2010)",
                             "State Founded (last 4 years)", 
                             "Network Exposure: Culture (t-1)",
                             "Network Exposure: Colonial",
                             "Network Exposure: Trade (t-1)",
                             "Network Exposrue: Spatial Proximity",
                             "GDPpc 10k USD",
                             "Democratization" 
                             ),
          apply.coef=exp, t.auto=F, p.auto=F, report = "vct*",
          out="results/Tbl2_OR.htm")

knitr::include_graphics("results/Tbl2_OR.htm")
```

### Coef Plots

#### First Law

```{r coefplots}

plot1 <- plot_coefs(model1,model2, coefs = c("A. Network Exposure:\n    Culture (t-1)" = "lag_w_expo_culture",
                                    "B. Network Exposure:\n    Colonial" = "w_expo_colony",
                                    "C. Network Exposure:\n    Trade (t-1)" = "lag_w_expo_trade",
                                    "D. Network Exposure:\n    Spatial Proximity" = "lag_w_expo_proximity", 
                                    "E. State Founded\n    (last 4 years)" = "existence",
                                    "F. GDPpc 10k USD" = "gdp10000", 
                                    "G. Democratization" = "regime"), colors = "Qual3") +
  coord_cartesian(xlim = c(-0.5,5)) + 
  theme(legend.position = "none",
        axis.text.y = element_text(hjust = 0)) +
  labs(title = "                          First Law") +
  xlab(label = "Coefficient + 95%CI")


```

#### Social insurance


```{r coefplots_socins}

plot2 <- plot_coefs(model1_socins,model2_socins, coefs = c("A" = "lag_w_expo_culture", "B" = "w_expo_colony", "C" = "lag_w_expo_trade", "D" = "lag_w_expo_proximity", "E" = "existence", "F" = "gdp10000", "G" = "regime"), colors = "Qual3") +
  coord_cartesian(xlim = c(-0.5,5)) + 
  theme(legend.position = "none") +
  labs(title = "    First Social Insurance Law") +
  xlab(label = "Coefficient + 95%CI")


agg_png(filename = "results/Fig1.png", height = 600, width = 1200, res = 144)
ggarrange(plot1, plot2, widths = c(1,0.8))

dev.off()

knitr::include_graphics("results/Fig1.png")


```

### Treatment plot

Plot sequences centered at the formation of nation states

```{r nation_plot}

# remove missing
treat_plot <- subset(treat_plot, formation != "Inf")
treat_plot$law_seq <- as.factor(as.character(treat_plot$law_seq, levels = c("1","2","3"), labels = c("None","Liability","Social Insurance")))

# order by formation
treat_plot <- treat_plot %>%
  mutate(order = ifelse(per == socins, formation, -1000),
         order = max(order, na.rm = T),
         order = ifelse(order == -1000, 1000, order))

treat_plot <- treat_plot[order(treat_plot$order),]

treat_plot <- treat_plot %>%
  ungroup() %>%
  mutate(n =  row_number()) 

treat_plot <- treat_plot %>%
  group_by(id) %>%
  mutate(n_id = max(n, na.rm =T)) %>%
  ungroup()



ggplot(treat_plot, aes(formation, n_id, fill = law_seq)) +
  geom_tile() +
  scale_fill_manual(breaks = c("1", "2", "3"),
  values = c("1","2","3"),
  labels = c("None", "Liability", "Social\nInsurance"),
  #colors = c("Grey","Brown","Darkgreen")
  ) +
  ylab(label = "Country") +
  xlab(label = "Time in Years\n(centered by year of state formation)") +
  xlim(-50,50) +
  theme(axis.text.y = element_blank())


```




```{r net1}
# ---------------------------------------------
# --- some functions of netdiffuseR, here for 
# --- the trade spheres network
# ---------------------------------------------

s <- 12345
cols <- c("lightblue","green", "blue")
oldpar <- par(no.readonly = T)
coords <- set.seed(s);plot(diffnet_trade, main="Trade and Work-Injury Law")
```


```{r net2}

plot_hazard(diffnet_trade, ylim=c(0,1))
```


```{r net2}
plot_infectsuscep(diffnet_trade)
```


```{r net3}
# network threshold: required proportion or number of neighbors that leads you to adopt
plot_threshold(diffnet_trade, undirected = FALSE, vertex.size = 1/5)
```


```{r net4}
# Classify Adopters
diffnet.toa(diffnet_trade)[diffnet_trade$toa==max(diffnet_trade$toa, na.rm = TRUE)] <- NA
out <- classify_adopters(diffnet_trade)


# This is one way to combine adopters ad thresholds in one object
round(
  with(out, ftable(toa, thr, dnn=c("Time of Adoption", "Threshold")))/
    nnodes(diffnet_trade[!is.na(diffnet_trade$toa)])*100, digits=2)
# ftable(out)

ids <- unique(edgelist_cultural_spheres$ego_id) 
ids <- as.data.frame(ids)

ids1 <- unique(edgelist_cultural_spheres$alter_id) 
ids1 <- as.data.frame(ids1)

colnames(ids1)[1] <- "ids"
ids <- rbind(ids, ids1)
ids <- unique(ids)
ids$ids <- as.character(ids$ids)

ids <- sort(ids)

# Adopter types and threshols combined
thresholds <- cbind(as.data.frame(classify(diffnet_culture)), diffnet_culture$toa, ids)
head(thresholds)
```

```{r net1_trade}




plot_threshold(diffnet_trade, undirected = FALSE, vertex.size = 1/5)

```

```{r se_corrections}
# ---------------------------------------------
# --- Calculate the  corrected standard errors
# --- the cultural spheres network
# ---------------------------------------------

# Standard error correction: Huber-White standard errors are calculated AFTER the model
# and used to re-calculate the significance

# step 1: calculate corrected standard errors and save output as an object: 


m1 <- lmtest::coeftest(model1, vcov = vcovCL(model1, type="HC3", cluster =~ cluster_id))
# unclear error taking place here


m1               
summary(model1)

m2 <- coeftest(model2, vcov = vcovCL(model2, type="HC3", cluster=~ cluster_id))

m2

m3 <- coeftest(model3, vcov = vcovCL(model3, type="HC3", cluster=~ cluster_id))

m3

m4 <- coeftest(model4, vcov = vcovCL(model4, type="HC3", cluster=~ cluster_id))

m4

# step 2: run stargazer3 with the following specification: 

# 1. odds.rations = T !SPELLING! 

# 2. stargazer3(list(m1, m2)...) this is the output of the coeftest function with the corrected
# standard erors!! NOT THE GLM OUTPUT !!

# 3. origin_model: GLM output. This is nessesary to add the model fit statistics to the table.


# BEWARE of the covariate label order!! All your models need the independent variables
# in the same order. If you have multiple models, add the ALL independent variable names to the function call below under covariate.labels!!
# If one model has less variables, this space will be empty only for that model.

# cheatsheets for starger modification: https://www.jakeruss.com/cheatsheets/stargazer/
# these work with stargazer 3 as well. 

# change the title, the dep.var.labels and the covariate.labels accordingly

stargazer3(list(m1, m2, m3, m4), odds.ratios = T, origin_model = list(model1, model2, model3, model4), type = "html", se = list(NA, NA, NA, NA),
           title = "Diffusion of Work-Inury Law - Cultural Spheres Network",
           dep.var.labels=c("Introduction of Compulsory Schooling"),
           covariate.labels=c("rate t(0-24)", 
                              "rate t(25-49)",
                              "rate t(50-74)",
                              "rate t(75-99)",
                              "rate t(100-130)",
                              "state existed (=1,else=0)", 
                              "GDP per capita / 10000 USD",
                              "democratization" ,
                              "cultural spheres netw.: w. exposure (lag 1 year)",
                              "colonies netw.: exposure ",
                              "trade net: w. exposure (lag 1 year)",
                              "spatial proximity netw.: w. exposure "
                              ),
           out="results/models_final2.htm")

# ---------------------------------------------
# --- some functions of netdiffuseR, here for 
# --- the cultural spheres network
# ---------------------------------------------

s <- 12345
cols <- c("lightblue","green", "blue")
oldpar <- par(no.readonly = T)
coords <- set.seed(s);plot(diffnet_culture, main="culture & education")


bmp(filename = "results/culture_edu.bmp") # - create folder, mac users adjust
plot_diffnet(diffnet_culture, 
             slices = c(1,50,100,130), layout=coords)
dev.off()

plot_adopters(diffnet_culture, 
              include.legend = FALSE, what = c("adopt", "cumadopt"))
plot_hazard(diffnet_culture, ylim=c(0,1))
plot_infectsuscep(diffnet_culture)

# network threshold: required proportion or number of neighbors that leads you to adopt
plot_threshold(diffnet_culture, undirected = FALSE, vertex.size = 1/5)

# Classify Adopters
diffnet.toa(diffnet_culture)[diffnet_culture$toa==max(diffnet_culture$toa, na.rm = TRUE)] <- NA
out <- classify_adopters(diffnet_culture)
out

# This is one way to combine adopters ad thresholds in one object
round(
  with(out, ftable(toa, thr, dnn=c("Time of Adoption", "Threshold")))/
    nnodes(diffnet_culture[!is.na(diffnet_culture$toa)])*100, digits=2)
ftable(out)

ids <- unique(edgelist_cultural_spheres$ego_id) 
ids <- as.data.frame(ids)

ids1 <- unique(edgelist_cultural_spheres$alter_id) 
ids1 <- as.data.frame(ids1)

colnames(ids1)[1] <- "ids"
ids <- rbind(ids, ids1)
ids <- unique(ids)
ids$ids <- as.character(ids$ids)

ids <- sort(ids)

# Adopter types and threshols combined
thresholds <- cbind(as.data.frame(classify(diffnet_culture)), diffnet_culture$toa, ids)
head(thresholds)


```

